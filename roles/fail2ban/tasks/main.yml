---
- name: Install fail2ban, ipset
  yum: name={{item}} state=present
  with_items:
    - fail2ban
    - ipset
    - jwhois

- name: Check if firewalld is installed
  stat: path=/etc/firewalld get_md5=no mime=no
  register: fail2ban_firewalld

- name: Create jail.d
  file: path=/etc/fail2ban/jail.d owner=root group=root mode=755 state=directory

- name: Include iptables
  include: iptables.yml
  when: fail2ban_firewalld.stat.isdir is not defined

- name: Include firewalld
  include: firewalld.yml
  when: fail2ban_firewalld.stat.isdir is defined

- name: Disable SSHD-iptables
  copy: src="ssh-iptables.conf" dest="/etc/fail2ban/jail.d/ssh-iptables.conf" mode=0644 owner=root group=root

- name: Configure SSHD-ipset Ban
  copy: src="ssh-ipset.conf"  dest="/etc/fail2ban/jail.d/ssh-ipset.conf" mode=0644 owner=root group=root

- name: Test VSFTP Existence
  stat: path=/etc/vsftpd get_md5=no mime=no
  register: fail2ban_vsftpd

- name: Configure VSFTP-ipset Ban
  copy: src="vsftp-ipset.conf"  dest="/etc/fail2ban/jail.d/vsftp-ipset.conf" mode=0644 owner=root group=root
  when: fail2ban_vsftpd.stat.exists

- name: Test Cyrus-Imap Existence
  stat: path=/etc/cyrus.conf get_md5=no mime=no
  register: fail2ban_cyrus

- name: Configure IMAP-ipset Ban
  stat: src="cyrus-imap.conf"  dest="/etc/fail2ban/jail.d/cyrus-imap.conf" mode=0644 owner=root group=root
  when: fail2ban_cyrus.stat.exists

- name: Setup ipset service
  copy: src=ipset.service dest=/etc/systemd/system/ipset.service owner=root group=root mode=0744
  when: ansible_os_family == "RedHat" and ansible_distribution_major_version|int == 7

- name: Install initial blacklist
  copy: src=ipset.save dest=/etc/sysconfig/ipset owner=root group=root mode=0744

- name: Enable ipset service
  service: name=ipset enabled=yes
  notify: restart ipset

- name: Enable fail2ban
  service: name=fail2ban enabled=yes
  notify: restart fail2ban
